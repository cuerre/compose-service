version: "3.5"



#Docker Networks
networks:
    internal:
        driver: bridge
        name: internal
    external:
        driver: bridge
        name: external
    


# Docker Volumes
volumes:
    database_data:
        name: database_data

    backend:
        name: backend

    backend_storage:
        name: backend_storage



# Docker services     
services:

    # MySQL Service
    database:
        image: mysql:8
        command: --default-authentication-plugin=mysql_native_password
        container_name: database
        restart: always
        tty: true
        stdin_open: true
        environment:
            MYSQL_ROOT_PASSWORD: root_password
        volumes:           
            - database_data:/var/lib/mysql/
            - ./build/database/docker-files:/docker-entrypoint-initdb.d
        expose:
            - "3306"
        # This is a temporary bugfix
        ports:
        - "3306:3306"
        networks:
            - internal
            - external

    # Adminer Service
    adminer:
        image: adminer
        container_name: adminer
        restart: always
        tty: true
        stdin_open: true
        ports:
            - 8080:8080
        networks:
            - external

    # Redis Service
    cache:
        image: redis:5-buster
        container_name: cache
        restart: always
        tty: true
        stdin_open: true
        expose:
            - "6379"
        networks:
            - internal

    # Web Service (backend)
    backend:
        build:
            context: ./build/backend
            dockerfile: Dockerfile
            args:
                GIT_APPLICATION: https://github.com/laravel/laravel.git
        image: backend:1-laravel
        depends_on:
            - database
            - cache
        container_name: backend
        restart: always
        tty: true
        stdin_open: true
        environment:
            APP_VENDOR: Achetronic
            APP_NAME: Your App
            APP_ENV: local
            APP_KEY: "base64:VNt8gejhfX7I3UwNv40focB3QOoH7Jofju9C4h5UeNY="
            APP_DEBUG: "true"
            APP_URL: http://your-url.com
            LOG_CHANNEL: stack
            DB_CONNECTION: mysql
            DB_HOST: database
            DB_PORT: 3306
            DB_DATABASE: service_test
            DB_USERNAME: normal_user
            DB_PASSWORD: normal_password
            BROADCAST_DRIVER: log
            CACHE_DRIVER: redis
            QUEUE_CONNECTION: sync
            SESSION_DRIVER: redis
            SESSION_LIFETIME: 120
            REDIS_HOST: cache
            REDIS_PASSWORD: null
            REDIS_PORT: 6379
            MAIL_DRIVER: smtp
            MAIL_HOST: smtp.sendgrid.net
            MAIL_PORT: 587
            MAIL_USERNAME: apikey
            MAIL_PASSWORD: "SG.ASDFASDFASDFASDF..."
            MAIL_ENCRYPTION: tls
            MAIL_FROM_NAME: "${APP_NAME}"
            MAIL_FROM_ADDRESS: noreply@your-url.com
        working_dir: /var/www
        volumes:
            - type: volume
              source: backend
              target: /var/www
            - type: volume
              source: backend_storage
              target: /var/www/storage
        expose:
            - "9000"
        networks: 
            - internal

    # Web Service (frontend)
    frontend:
        build:
            context: ./build/frontend
            dockerfile: Dockerfile
        image: frontend:1-nginx
        container_name: frontend
        depends_on:
            - backend
        restart: always
        tty: true
        stdin_open: true
        working_dir: /var/www
        volumes:
            - type: volume
              source: backend
              target: /var/www
              volume:
                nocopy: true
                read_only: true
        expose:
            - "80"
            - "443"
        ports:
            - "80:80"
            - "443:443"
        networks:
            - internal
            - external

